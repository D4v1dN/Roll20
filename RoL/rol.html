
<!-- ==== Sheet definition ==== -->

<div class="sheet-main">
    <!-- Hidden attributes for calculated values -->
    <input type="hidden" name="attr_character_str_half" value="0"> 	
    <input type="hidden" name="attr_character_con_half" value="0"> 	
    <input type="hidden" name="attr_character_dex_half" value="0"> 	
    <input type="hidden" name="attr_character_int_half" value="0"> 	
    <input type="hidden" name="attr_character_pow_half" value="0"> 	
    <input type="hidden" name="attr_character_athletics_half" value="0"> 	
    <input type="hidden" name="attr_character_drive_half" value="0"> 	
    <input type="hidden" name="attr_character_navigate_half" value="0"> 	
    <input type="hidden" name="attr_character_observation_half" value="0"> 	
    <input type="hidden" name="attr_character_readp_half" value="0"> 	
    <input type="hidden" name="attr_character_research_half" value="0"> 	
    <input type="hidden" name="attr_character_sensev_half" value="0"> 	
    <input type="hidden" name="attr_character_social_half" value="0"> 	
    <input type="hidden" name="attr_character_stealth_half" value="0"> 
    <input type="hidden" name="attr_character_fighting_half" value="0"> 	
    <input type="hidden" name="attr_character_firearms_half" value="0"> 
    <input type="hidden" name="attr_character_impared" value=""> 

    
    <div class="sheet-header">
    	<span>Rivers of London - version 0.1 alpha</span> 
    </div>
    <div class="sheet-grid-section">	
    	<div class="sheet-bio sheet-block">
        	<div class="sheet-section-inner-container">
        	    <h4 class="sheet-section-head">Investigator Info</h4>
        		<div class="sheet-section-row">
        			<label class="sheet-bio-label">Occupation</label>
        			<input class="sheet-bio-input" name="attr_character_occupation" type="text">
        		</div>
        		<div  class="sheet-section-row">
        			<label class="sheet-bio-label">Place of birth</label>
        			<input class="sheet-bio-input" name="attr_character_birthplace" type="text">
        		</div>
        		<div  class="sheet-section-row">
        			<label class="sheet-bio-label">Residence</label>
        			<input class="sheet-bio-input" name="attr_character_residence" type="text">
        		</div>
        		<div  class="sheet-section-row">
        			<label class="sheet-bio-label">Pronoun</label>
        			<input class="sheet-bio-input" name="attr_character_pronoun" type="text">
        		</div>
        		<div  class="sheet-section-row">
        			<label class="sheet-bio-label">Age</label>
        			<input class="sheet-bio-input" name="attr_character_age" type="text">
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-bio-label">Affluence</label>
        			<input class="sheet-bio-input" name="attr_character_affluence" type="text">
        		</div>	
    		</div>
    	</div>
    	
    	<div class="sheet-stats sheet-block">
    	    <div class="sheet-section-inner-container">
    	    
        	    <h4 class="sheet-section-head">Characteristics</h4>
        		<div class="sheet-section-row">
        			<label class="sheet-short-label">STR</label>
        			<input name="attr_character_str" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_str_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Strength}} {{success=[[@{character_str}]]}} {{hard=[[@{character_str_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-short-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			    <label class="sheet-short-label">CON</label>
        			    <input name="attr_character_con" type="number" min="0" max="100"> 
        			    <span class="sheet-input-seperator">/</span>
            			<input name="attr_character_con_half" type="number" value="0" readonly> 	
            			<button name="roll_con" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Constitution}} {{success=[[@{character_con}]]}} {{hard=[[@{character_con_half}]]}} {{roll=[[d100]]}}"></button>
          			    <br>
           			    <span class="sheet-hint-short-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-short-label">DEX</label>
        			<input name="attr_character_dex" type="number" min="0" max="100">
        			<span>/</span>
        			<input name="attr_character_dex_half" type="number" value="0" readonly> 	
        			<button name="roll_dex" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Dexterity}} {{success=[[@{character_dex}]]}} {{hard=[[@{character_dex_half}]]}} {{roll=[[d100]]}}"></button>
        	  	    <br>
       			    <span class="sheet-hint-short-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-short-label">INT</label>
        			<input name="attr_character_int" type="number" min="0" max="100">
        			<span>/</span>
        			<input name="attr_character_int_half" type="number" value="0" readonly> 
        			<button name="roll_int" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Intelligence}} {{success=[[@{character_int}]]}} {{hard=[[@{character_int_half}]]}} {{roll=[[d100]]}}"></button>
          			 <br>
       			    <span class="sheet-hint-short-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-short-label">POW</label>
        			<input name="attr_character_pow" type="number" min="0" max="100">
        			<span>/</span>
        			<input name="attr_character_pow_half" type="number" value="0" readonly> 	
        			<button name="roll_pow" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Power}} {{success=[[@{character_pow}]]}} {{hard=[[@{character_pow_half}]]}} {{roll=[[d100]]}}"></button>
      			    <br>
       			    <span class="sheet-hint-short-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        	</div>
    	</div>
    	
    	<div class="sheet-sup sheet-block">
    	    <div class="sheet-section-inner-container">
        	    <h4 class="sheet-section-head">Suplimental info</h4>
        		<div class="sheet-section-row">
        			<label class="sheet-short-label">MOV</label>
        			<input name="attr_character_mov" type="number">
        			<br>
       			    <span class="sheet-hint-short-label">&nbsp;</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-short-label">Luck</label>
        			<input name="attr_character_luck" type="number">
        			<span>/</span>
        			<input name="attr_character_luck_current" type="number">
      			    <br>
       			    <span class="sheet-hint-short-label">&nbsp;</span><span class="sheet-hint-starting">Starting</span><span class="sheet-hint-current">Current</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-short-label">Magic</label>
        			<input name="attr_character_magicpts" type="number">
        			<span>/</span>
        			<input name="attr_character_magicpts_current" type="number">
      			    <br>
       			    <span class="sheet-hint-short-label">&nbsp;</span><span class="sheet-hint-starting">Starting</span><span class="sheet-hint-current">Current</span>  			
        		</div>
        	</div>
    	</div>
    	
    	<div class="sheet-notes sheet-block">
    	    <div class="sheet-section-inner-container">
        	    <h4 class="sheet-section-head">Notes</h4>
        		<div class="sheet-textarea-div">
        			<textarea class="sheet-textarea-notes" name="attr_character_notes" rows="3"></textarea>
        		</div>
        	</div>
    	</div>
    	
    	<div class="sheet-advantages sheet-block">
    	    <div class="sheet-section-inner-container">
        		<h4 class="sheet-section-head">Advantages & disadvantages</h4>
        		<div class="sheet-2colrow sheet-adv-div">
        		    <div class="sheet-col">
        		        <input class="sheet-adv-input" name="attr_character_adv1" type="text">
    		        	<input class="sheet-adv-input" name="attr_character_adv2" type="text">
    		        	<input class="sheet-adv-input" name="attr_character_adv3" type="text">
        		    </div>
    
        		    <div class="sheet-col">
        		        <input class="sheet-adv-input" name="attr_character_adv4" type="text">
                		<input class="sheet-adv-input" name="attr_character_adv5" type="text">
        		        <input class="sheet-adv-input" name="attr_character_adv6" type="text">
        		    </div>
        		</div>
        	</div>
    	</div>

    	<div class="sheet-common sheet-block">
    	    <div class="sheet-section-inner-container">
        	    <h4 class="sheet-section-head">Common skills</h4>
        		<div class="sheet-section-row">
        			<label class="sheet-long-label">Athletics</label>
        			<input name="attr_character_athletics" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_athletics_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Athletics}} {{success=[[@{character_athletics}]]}} {{hard=[[@{character_athletics_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-long-label">Drive</label>
        			<input name="attr_character_drive" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_drive_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Drive}} {{success=[[@{character_drive}]]}} {{hard=[[@{character_drive_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>    		
        		<div class="sheet-section-row">
        			<label class="sheet-long-label">Navigate</label>
        			<input name="attr_character_navigate" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_navigate_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Navigate}} {{success=[[@{character_navigate}]]}} {{hard=[[@{character_navigate_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-long-label">Observation</label>
        			<input name="attr_character_observation" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_observation_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Observation}} {{success=[[@{character_observation}]]}} {{hard=[[@{character_observation_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-long-label">Read Person</label>
        			<input name="attr_character_readp" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_readp_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent}  {{character_name=@{character_name}}} {{name=Read Person}} {{success=[[@{character_readp}]]}} {{hard=[[@{character_readp_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-long-label">Research</label>
        			<input name="attr_character_research" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_research_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Research}} {{success=[[@{character_research}]]}} {{hard=[[@{character_research_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-long-label">Sense Vestigia</label>
        			<input name="attr_character_sensev" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_sensev_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Sense Vestigia}} {{success=[[@{character_sensev}]]}} {{hard=[[@{character_sensev_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-long-label">Social</label>
        			<input name="attr_character_social" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_social_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Social}} {{success=[[@{character_social}]]}} {{hard=[[@{character_social_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>    		
        		<div class="sheet-section-row">
        			<label class="sheet-long-label">Stealth</label>
        			<input name="attr_character_stealth" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_stealth_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Stealth}} {{success=[[@{character_stealth}]]}} {{hard=[[@{character_stealth_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>    	
        	</div>
    	</div>
    	
    	<div class="sheet-expert sheet-block">
    	    <div class="sheet-section-inner-container">
    	        <h4 class="sheet-section-head">Expert skills</h4>
    	   </div>
    	</div>
    	
    	<div class="sheet-combat sheet-block">
    	    <div class="sheet-section-inner-container">
        	    <h4 class="sheet-section-head">Combat skills</h4>
       		    <div class="sheet-section-row">
        			<label class="sheet-long-label">Fighting</label>
        			<input name="attr_character_fighting" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_fighting_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Fighting}} {{success=[[@{character_fighting}]]}} {{hard=[[@{character_fighting_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>
        		<div class="sheet-section-row">
        			<label class="sheet-long-label">Firearms</label>
        			<input name="attr_character_firearms" class="sheet-input-align-top" type="number" min="0" max="100">
        			<span>/</span>
        			<input type="number" class="sheet-input-align-top" name="attr_character_firearms_half" value="0" readonly>
       			    <button name="roll_str" type="roll" value="&{template:rol-percent} {{character_name=@{character_name}}} {{name=Firearms}} {{success=[[@{character_firearms}]]}} {{hard=[[@{character_firearms_half}]]}} {{roll=[[d100]]}}"></button>
       			    <br>
       			    <span class="sheet-hint-long-label">&nbsp;</span><span class="sheet-hint-full">Full</span><span class="sheet-hint-half">Half</span>
        		</div>    		
    	    </div>
    	</div>
    	
    	<div class="sheet-damage sheet-block">
    	    <div class="sheet-section-inner-container">
    	        <h4 class="sheet-section-head">Damage</h4>
    	        <div class="sheet-section-row">
    	            <label class="sheet-long-label">Damage</label>
                    <select name="attr_character_status">
                        <option value="0" selected="selected">0: Unharmed</option>
                        <option value="1">1: Hurt</option>
                        <option value="2">2: Bloodied</ophttps://app.roll20.net/campaigns/campaignsettings/13911731#customsheet-csstion>
                        <option value="3">3: Down</option>
                        <option value="4">4: (in one attack)</option>
                        <option value="5">5: (in one attack)</option>
                    </select>
                </div>
                <div class="sheet-section-row">
                    <input type="text" class="sheet-damage-special" name="attr_character_impared" readonly>
                </div>
               	        
    	   </div>
    	</div>
    	
    	<div class="sheet-weapons sheet-block">
    	    <div class="sheet-section-inner-container">
    	        <h4 class="sheet-section-head">Weapons</h4>
    	   </div>
    	</div>
    	
    	<div class="sheet-magic sheet-block">
    	    <div class="sheet-section-inner-container">
    	        <h4 class="sheet-section-head">Magic</h4>
    	   </div>
    	</div>
    </div>
</div>

<!-- ==== Roll Templates ==== -->


<rolltemplate class="sheet-rolltemplate-rol-percent">
    <div class="sheet-template-charname">{{character_name}}</div>
    <div class="sheet-template-container">
    	<div class="sheet-template-rollname">
            {{name}}      
    	</div>
    	<div class="sheet-template-values">Values: {{success}} / {{hard}}</div>
    	<div class="sheet-template-result">
    	    {{#rollGreater() roll success}}
    	        <span class="sheet-template-failure">Failure: {{roll}}</span>
    	    {{/rollGreater() roll success}}
    	    {{#^rollGreater() roll success}}
    	        {{#rollGreater() roll hard}}
    	            <span class="sheet-template-success">Normal success: {{roll}}</span>
    	        {{/rollGreater() roll hard}}
    	        {{#^rollGreater() roll hard}}
    	            <span class="sheet-template-hard">Hard success: {{roll}}</span>
    	        {{/^rollGreater() roll hard}}
    	    {{/^rollGreater() roll success}}
    	</div>    	
    </div>
</rolltemplate>

<!-- ==== Sheet worker ==== -->

<script type="text/worker">

    // ==== handle updating 'half' values ====
    const halfAttrList = [
            "character_str",
            "character_con",
            "character_dex",
            "character_int",
            "character_pow",
            "character_athletics",
            "character_drive",
            "character_navigate",
            "character_observation",
            "character_readp",    
            "character_research",
            "character_sensev",
            "character_social",  
            "character_stealth",  
            "character_fighting",  
            "character_firearms",              
    ]
    
    // perform the update
    function updateHalfAttr(attr) {
        getAttrs([attr], function(values) {
            let srcVal = Object.values(values)[0]
            let intval = parseInt(srcVal)||0;
            let destval = Math.floor(intval / 2);
            let destHash = {}
            destHash[`${attr}_half`] = destval
            setAttrs(destHash);
    
       });
    }
    
    // on shee open update all
    on("sheet:opened", function() { 
        halfAttrList.forEach(updateHalfAttr);
    });
    
    // on change only update the one that has changed
    on("change:character_str", function() { 
       updateHalfAttr("character_str");
    });
    on("change:character_con", function() { 
       updateHalfAttr("character_con");
    });
    on("change:character_dex", function() { 
        updateHalfAttr("character_dex");
    });
    on("change:character_int", function() { 
        updateHalfAttr("character_int");
    });
    on("change:character_pow", function() { 
        updateHalfAttr("character_pow");
    });
    on("change:character_athletics", function() { 
       updateHalfAttr("character_athletics");
    });
    on("change:character_drive", function() { 
       updateHalfAttr("character_drive");
    });
    on("change:character_navigate", function() { 
        updateHalfAttr("character_navigate");
    });
    on("change:character_observation", function() { 
        updateHalfAttr("character_observation");
    });
    on("change:character_readp", function() { 
        updateHalfAttr("character_readp");
    });
    on("change:character_research", function() { 
       updateHalfAttr("character_research");
    });
    on("change:character_sensev", function() { 
       updateHalfAttr("character_sensev");
    });
    on("change:character_social", function() { 
        updateHalfAttr("character_social");
    });
    on("change:character_stealth", function() { 
        updateHalfAttr("character_stealth");
    });
    on("change:character_fighting", function() { 
        updateHalfAttr("character_fighting");
    });
    on("change:character_firearms", function() { 
        updateHalfAttr("character_firearms");
    });  
    
    /* damage */
    on("sheet:opened change:character_status", function() { 
      getAttrs(["character_status"], function(values) {
            let srcVal = Object.values(values)[0]
            let intval = parseInt(srcVal)||0;
            let special = ""
            switch (intval) {
                case 2:
                case 3:
                    special = "** Impared"
                    break;   
                case 4: 
                    special = "** Mortal wound"
                    break; 
                case 5: 
                    special = "** Fatal blow"
                    break;                     
                    
            }
            let destHash = {}
            destHash["character_impared"] = special;
            setAttrs(destHash);
       });        
    });  

</script>